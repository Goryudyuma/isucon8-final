# ISUCON8 本選マニュアル

# はじめに

## スケジュール

- 10:00 競技開始
- 18:00 競技終了
- 以後主催者により結果チェックと追試


## ISUCON8 本選 ポータルサイト

本選は以下のポータルサイトからベンチマーク走行のリクエスト・結果チェックを行って進行します。
競技の開始時間になりましたら、事前に通知されているIDとパスワードを用いてポータルサイトへログインしてください。

**このページは18:00を過ぎると即座に閲覧不可能になります。ご注意ください。**

**https://portal.isucon8.flying-chair.net/**

ポータルサイトでは、ベンチマーカーが負荷をかける対象となるサーバーを1台選択することができます。
後述する競技後の追試でもこの設定を利用します。

**追試が実行できない場合は失格になるので、競技終了までにこの情報が正しいことを必ず確認してください。**

ポータルサイトでは、ベンチマーク走行の処理状況も確認できます。
ベンチマーク走行が待機中もしくは実行中の間はリクエストは追加できません。


## サーバー、ネットワーク構成について

競技者には、同一スペックの4台のサーバーが与えられます。
サーバーには連番のプライベートIPが割り振られており、初期構成ではすべてのサーバーに同じアプリケーションがデプロイされています。

各サーバーにはNICが3つ接続されていて、それぞれグローバルIPとプライベートIPとベンチマーカーIPが割り振られています。
各IPアドレスはポータルサイトから確認することができます。

競技者がサーバーに接続して作業を行う際や、Webブラウザ等で動作確認を行う際は **グローバルIP** を使用することができます。
サーバー間で通信を行う際は **プライベートIP** を使用することができます。
ベンチマーク走行は **ベンチマーカーIP** に対して実行されます。

グローバルIP側の帯域制限は、50Mbpsです。
プライベートIP側、ベンチマーカーIP側の帯域制限は、それぞれ1Gbpsです。


# 作業開始

以下の順序で作業を開始してください。


## 1. サーバーへのログイン

ポータルサイトに書かれてるグローバルIPアドレスに対して `ssh` してください。
サーバーはパスワード認証になっていて、ユーザー名は `isucon` 、パスワードはポータルサイト上で確認できます。

サーバーには本選終了後の主催者による確認作業(追試)のため、 `isucon-admin` ユーザーのアカウントがあります。

**`isucon-admin` ユーザーのアカウントに関して、アカウントの削除や既存の公開鍵の削除を行ったことにより主催者による追試をおこなうことができない場合は、失格とします。**


## 2. アプリケーションの動作確認

ポータルのサーバ情報の hostname を元に `https://{hostname}.isucon8.flying-chair.net` というURLでアクセスしてください。

`GET /` へアクセスすることで、トップページにアクセスすることができます。
画面右上の「サインアップ」から、ユーザを作成することができます。

#### 動作試験用いすこん銀行アカウント

以下のいすこん銀行アカウント (bank id) をベンチマークに影響しない富豪アカウントとして自由に使って構いません。
それぞれ残高は10億あります。

```
isucon-{001..100}
```


## 3. 負荷走行

ベンチマーク走行を行う際はポータルサイト上からリクエストします。
リクエストの際には対象となるサーバーの設定が必要です。

ポータルサイト上のServersタブにアクセスして、ベンチマーク走行を実行したいサーバーにチェックを入れて、設定を保存してください。

ポータルサイト上のDashboardタブにアクセスして、Enqueueをクリックすると、ベンチマーク走行リクエストがキューイングされ、主催者が用意したベンチマークサーバにより順次処理されます。
詳細については後述します。


## 参照実装の切り替え方法

TODO: 事前解答ではgolangのみです

```
sudo systemctl (start|stop) isucoin
```

## リカバリ方法

TODO

# アプリケーションについて

## ストーリー

TODO: 動画等に置き換え

- いすこん銀行は、いすこん銀行の口座とAPIで連携した「仮想椅子取引所ISUCOIN」を開設
- 世界的に椅子ブームを追い風に取引も順調
- 社長は世界的SNS「いすばた」とプロモーション契約を締結し「いすばたシェア」機能を実装
- しかし、「いすばたシェア」の驚異的な拡散力により負荷に耐えられないことが発覚
- 社長「緊急メンテナンスをいれていいので18時までに改修しろ。18時にプロモーション開始だ」

## 概要

仮想の椅子の取引所です。

椅子の買い注文と売り注文を行うことができ、注文の条件を満たせば取引が成立します。
成立した取引を示すロウソクチャートは毎秒更新されており、チャートはゲストユーザーからも参照することができます。

- 詳細仕様: docs/WEBAPP_SPEC.md

## 外部API

アプリケーションは2つの外部APIを利用しており、ビジネス的な観点でそれらを必ず利用しなければなりません。

#### いすこん銀行API (isubank)

口座の入出金や残高確認を行うAPI

- 詳細仕様: docs/ISUBANK_SPEC.md


### 分析API (isulogger)

リアルタイム分析を行うログ分析API

ログ送信内容の改変は認められず、欠落も認められません。
また、遅延は10秒以内としなければなりません。

同時に発行できるリクエストは最大10並列、20req/secまでに制限されています。制限を超過すると 429 Too Many Requests が返ります。

- 詳細仕様: docs/ISULOGGER_SPEC.md


# ルール詳細

指定された競技用サーバー上のアプリケーションのチューニングを行い、それに対するベンチマーク走行のスコアで競技を行います。
与えられた競技用サーバーのみでアプリケーションの動作が可能であれば、どのような変更を加えても構いません。
ベンチマーカーとブラウザの挙動に差異がある場合、ベンチマーカーの挙動を正とします。
また、初期実装は言語毎に若干の挙動の違いはありますが、ベンチマーカーに影響のない挙動に関しては仕様とします。

## ベンチマーク走行

ベンチマーク走行は以下のように実施されます。

1. 初期化処理の実行 `GET /initialize` (30秒以内)
2. アプリケーション互換性チェックの走行 (適宜: 数秒〜数十秒)
3. 負荷走行 (60秒)
4. 負荷走行後の確認 (適宜: 数秒〜数十秒)

各ステップで失敗が見付かった場合にはその時点で停止します。

負荷走行中のエラーについては、後述の成功とみなすリクエスト以外を原則エラーとし、負荷走行開始からの合計エラー数が規定値を超えた場合は負荷走行を失敗とみなします。

- 50x系エラーに関してはリトライを行いますが、リトライを含めて10秒以内に返せなかった場合はタイムアウトとみなしエラーとします。
- エラーの既定値は、10回から始まり獲得スコアに応じて増加し、最大50回となっています。
- 負荷走行完了前に後述のアクティブユーザーが0人となってしまった場合もエラーとなります。


## スコア計算

スコアは上記3の負荷走行中に成功したリクエスト数をベースに計算されます。
リクエスト当たりの点数は以下のルールで計算され、その合計がベンチマーク走行のスコアとなります。

| スコア対象 | スコア |
|------------|--------|
| `GET /` 及びページを表示するための静的ファイル | 1 |
| `GET /info` | 1 |
| `POST /signup` | 1 |
| `POST /signin` | 1 |
| `GET /orders` | 1 |
| `POST /orders` | 5 |
| `DELETE /order/{id}` | 3 |
| 取引成立した注文 | 10 |

以下を満たした場合リクエストが成功したと判定します。

- タイムアウトせずにレスポンスを返却する
- HTTPステータスコードが想定と一致する
- コンテンツの内容チェックを通過する

HTTPステータスコードは、基本的に参照実装と同一のものを想定しています。
ただし、静的コンテンツに関しては、HTTPの規則の範囲内でステータスコード200の代わりに304を返すことができます。

なお、各APIの成約事項はAPIドキュメントを参照してください。

#### エラーによる減点

エラーの回数に応じて下記の式で減点を行います

```
score * ( 1 - error_count / 100 )
```

* error_count の最大値は 50 なので最大で 50% 減点します


## アクティブユーザーの増加

負荷走行中、一定の条件下でアクティブユーザーが自然増加します。

ただし、リクエストがタイムアウトした場合、そのユーザーは離脱します。

また、各ユーザーのSNSシェア機能を有効化した場合、注文成立時にSNSシェアによってアクティブユーザーが流入します。


## 制約事項

以下の事項に抵触すると失格(fail)となり、点数が0点になります。

- `GET /initialize` へのレスポンスが30秒以内に戻らない場合
- アプリケーション互換性チェックに失敗した場合
- 負荷走行後の確認へのレスポンスがそれぞれ下記の規定秒数以内に戻らない場合
- その他、ベンチマーカーのチェッカが失敗を検出したケース

最初に呼ばれる初期化処理 `GET /initialize` は用意された環境内で、チェッカツールが要求する範囲の整合性を担保します。
サーバーサイドで処理の変更・データ構造の変更などを行う場合、この処理が行っている内容を漏れなく提供してください。
また、この処理が30秒以上レスポンスを返さない場合、失格とします。

アプリケーションは全て、保存データを永続化する必要があります。
つまり処理実施後に再起動が行われた場合、再起動前に行われた処理内容が再起動後に保存されている必要があります。
また、アプリケーションは、ブラウザ上での表示を初期状態と同様に保つ必要があります。
本選終了後に行われる主催者による確認作業(追試)においてこれらの点が確認されます。


# リーダーボードの更新について

ポータルサイト上のリーダーボードのスコアは、競技終了前の1時間は表示は更新されなくなり、自チームのスコアのみ確認が可能になります。


## 本選終了後の作業について

本選終了後は、サーバーに対して一切の操作を行わないでください。
運営が追試に利用します。
終了後、主催者からベンチマーク走行成績の追試、ならびにデータ永続化、画面表示に関するチェックが行われます。


# 既知の問題

ブラウザでログインしている状態で、ベンチマークを回すと `/initialize` でユーザーを削除してしまうため、予期せぬ不具合が発生する場合があります。
404を返しますが、念の為速やかにリロードしてください。

# その他

サポートは事前に連絡のあった discord のチャンネルにて行いますが、基本的に、本選環境の構成・操作方法やベンチマーカーの処理内容については返答しません。
また、以下のURLにこれまで返答された質問などがまとめられています。
何かある時には一度ご覧ください。
